syntax = "proto3";

package user.v1;

service UserService {
  rpc GetUserInfo(GetUserInfoRequest) returns (GetUserInfoResponse) {}
  rpc ChangeNickname(ChangeNicknameRequest) returns (ChangeNicknameResponse) {}
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse) {}
  rpc BindMobile(BindMobileRequest) returns (BindMobileResponse) {}
  rpc UnbindMobile(UnbindMobileRequest) returns (UnbindMobileResponse) {}
  rpc GetPermissionList(GetPermissionListRequest) returns (GetPermissionListResponse) {}
  rpc ListUserDevices(ListUserDevicesRequest) returns (ListUserDevicesResponse) {}
  rpc LogoutDevice(LogoutDeviceRequest) returns (LogoutDeviceResponse) {}

  // 后台
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  rpc AdminUpdateUserPassword(AdminUpdateUserPasswordRequest) returns (AdminUpdateUserPasswordResponse);
  rpc UpdateUserStatus(UpdateUserStatusRequest) returns (UpdateUserStatusResponse);
  rpc AdminUpdateUserNicknameAndDescription(AdminUpdateUserNicknameAndDescriptionRequest) returns (AdminUpdateUserNicknameAndDescriptionResponse);
  rpc AdminUpdateUserMobile(AdminUpdateUserMobileRequest) returns (AdminUpdateUserMobileResponse);
  rpc AdminUpdateUserMaxDevices(AdminUpdateUserMaxDevicesRequest) returns (AdminUpdateUserMaxDevicesResponse);
}

message GetUserInfoRequest {}

message GetUserInfoResponse {
  string user_id = 1;
  string username = 2;
  bool can_access_backend = 3;
  string nickname = 4;
  uint64 created_at = 5;
  string mobile = 6;
  uint64 expired_at = 7;
  uint32 max_devices = 8; // 最大设备数量限制
}

message ChangeNicknameRequest {
  string nickname = 1;
}

message ChangeNicknameResponse {}

message ChangePasswordRequest {
  string password = 1;
}

message ChangePasswordResponse {}

message BindMobileRequest {
  string mobile = 1;
}

message BindMobileResponse {}

message UnbindMobileRequest {}

message UnbindMobileResponse {}

message GetPermissionListRequest {}

message GetPermissionListResponse {
  repeated string enabled_methods = 1; // 用户角色拥有的方法权限列表
  repeated string llm_models_disabled = 2;
  uint64 count_limit_daily_llm_talk_right_side = 3;
  uint64 count_limit_keyword = 4;
  uint64 count_limit_category = 5;
  uint64 count_limit_daily_free_ask = 6;
}

message ListUsersRequest {
  uint32 page_number = 1;
  uint32 limit = 2;
}

message ListUsersResponse {
  uint32 total_count = 1;
  uint32 page_size = 2;
  uint32 total_page = 3;
  uint32 current_page = 4;
  repeated UserWithDescription items = 5;
}

message UserWithDescription {
  string user_id = 1;
  string username = 2;
  bool can_access_backend = 3;
  bool enabled = 4;
  string nickname = 5;
  string description = 6;
  uint64 created_at = 7;
  string mobile = 8;
  uint32 max_devices = 9; // 最大设备数量限制
}

message CreateUserRequest {
  string username = 1;
  string password = 2;
  string nickname = 3;
  string description = 4;
  string role_id = 5; // 普通用户的角色ID 不可以为空
}

message CreateUserResponse {
  string user_id = 1;
}

message AdminUpdateUserPasswordRequest {
  string user_id = 1;
  string password = 2;
}

message AdminUpdateUserPasswordResponse {}

message UpdateUserStatusRequest {
  string user_id = 1;
  bool enabled = 2;
}

message UpdateUserStatusResponse {}

message AdminUpdateUserNicknameAndDescriptionRequest {
  string user_id = 1;
  string nickname = 2;
  string description = 3;
}

message AdminUpdateUserNicknameAndDescriptionResponse {}

message AdminUpdateUserMobileRequest {
  string user_id = 1;
  string mobile = 2;
}

message AdminUpdateUserMobileResponse {}

message AdminUpdateUserMaxDevicesRequest {
  string user_id = 1;
  uint32 max_devices = 2; // 最大设备数量限制
}

message AdminUpdateUserMaxDevicesResponse {}

// 设备信息
message DeviceInfo {
  string token_id = 1; // 设备ID/Token ID
  string login_user_agent = 2; // 登录时的UserAgent
  string login_ip = 3; // 登录时的IP
  uint64 login_time = 4; // 登录时间（Unix时间戳）
  string last_active_user_agent = 5; // 最后活跃时的UserAgent
  string last_active_ip = 6; // 最后活跃时的IP
  uint64 last_active_time = 7; // 最后活跃时间（Unix时间戳）
  bool is_current = 8; // 是否当前设备
}

// 查询登录设备列表
message ListUserDevicesRequest {}

message ListUserDevicesResponse {
  repeated DeviceInfo devices = 1;
}

// 踢出设备（使设备token失效）
message LogoutDeviceRequest {
  string token_id = 1; // 要踢出的设备token_id
}

message LogoutDeviceResponse {}
