syntax = "proto3";

package zsxq.v1;

service ZsxqService {
  rpc GetCookieInfo(GetCookieInfoRequest) returns (GetCookieInfoResponse);
  rpc UpdateCookieInfo(UpdateCookieInfoRequest) returns (UpdateCookieInfoResponse);

  // 从平台侧同步所有群组到本地数据库
  rpc SyncGroups(SyncGroupsRequest) returns (SyncGroupsResponse);
  // 从平台侧同步指定群组的帖子到本地数据库
  rpc SyncGroupTopics(SyncGroupTopicsRequest) returns (SyncGroupTopicsResponse);

  // 从本地数据库获取所有群组
  rpc ListAllGroups(ListAllGroupsRequest) returns (ListAllGroupsResponse);
  // 从本地数据库获取帖子
  rpc ListGroupTopics(ListGroupTopicsRequest) returns (ListGroupTopicsResponse);

  // 删除帖子（知识星球+本地）
  rpc DeleteGroupTopic(DeleteGroupTopicRequest) returns (DeleteGroupTopicResponse);

  // 更新是否是精华帖（知识星球+本地）
  rpc UpdateGroupTopicStar(UpdateGroupTopicStarRequest) returns (UpdateGroupTopicStarResponse);

  // 更新星球的配置
  rpc UpdateGroupConfig(UpdateGroupConfigRequest) returns (UpdateGroupConfigResponse);
  // 获取星球的文件配置
  rpc GetGroupConfig(GetGroupConfigRequest) returns (GetGroupConfigResponse);

  // PDF上传管理
  rpc UploadPDF(UploadPDFRequest) returns (UploadPDFResponse);
  rpc ListUploadedPDFs(ListUploadedPDFsRequest) returns (ListUploadedPDFsResponse);
  rpc UpdatePDFName(UpdatePDFNameRequest) returns (UpdatePDFNameResponse);
  rpc DeletePDF(DeletePDFRequest) returns (DeletePDFResponse);

  // 预览发送PDF到星球（会提前生成好PDF文件）
  rpc PreviewPostPDFToGroup(PreviewPostPDFToGroupRequest) returns (PreviewPostPDFToGroupResponse);

  // 确认发送PDF到星球（可以定时或者立即发送）
  rpc ConfirmPostPDFToGroup(ConfirmPostPDFToGroupRequest) returns (ConfirmPostPDFToGroupResponse);
}

message LoginRequest {
  string username = 1;
  string password = 2;
}

message LoginResponse {
  string token = 1;
}

message GetCookieInfoRequest {
}

message GetCookieInfoResponse {
  uint64 user_id    = 1;
  string cookie     = 2;
  uint64 expires_at = 3;
  uint64 updated_at = 4;
  bool   valid      = 5;
  uint64 synced_at  = 6;
  string err_reason = 7;
}

message UpdateCookieInfoRequest {
  uint64 user_id    = 1;
  string cookie     = 2;
  uint64 expires_at = 3;
}

message UpdateCookieInfoResponse {
}

message SyncGroupsRequest {
}

message SyncGroupsResponse {
}

message SyncGroupTopicsRequest {
  uint64 group_id = 1;
}

message SyncGroupTopicsResponse {
}

message ListAllGroupsRequest {
}

message ListAllGroupsResponse {
  repeated Group groups = 1;
}

message Group {
  uint64 id         = 1;
  string name       = 2;
  string image_url  = 3;
  uint64 created_at = 4;
}

message ListGroupTopicsRequest {
  uint64 group_id    = 1;
  uint32 page_number = 2;
  uint32 limit       = 3;
}

message ListGroupTopicsResponse {
  uint32         total_count  = 1;
  uint32         page_size    = 2;
  uint32         total_page   = 3;
  uint32         current_page = 4;
  repeated Topic topics       = 5;
}

message Topic {
  uint64        id          = 1;
  string        content     = 2;
  repeated File files       = 3;
  uint64        created_at  = 4;
  bool          is_star     = 5;
  uint64        author_id   = 6;
  string        author_name = 7;
}

message File {
  uint64 id         = 1;
  string name       = 2;
  string hash       = 3;
  uint64 size       = 4;
  uint64 created_at = 5;
}

message DeleteGroupTopicRequest {
  uint64 topic_id = 1;
}

message DeleteGroupTopicResponse {
}

message UpdateGroupTopicStarRequest {
  uint64 topic_id = 2;
  bool   is_star  = 3;
}

message UpdateGroupTopicStarResponse {
}

message GroupConfig {
  string pdf_cover_file_url           = 1;
  string article_auto_pdf_name_format = 2;
}

message UpdateGroupConfigRequest {
  uint64      group_id = 1;
  GroupConfig config   = 2;
}

message UpdateGroupConfigResponse {
}

message GetGroupConfigRequest {
  uint64 group_id = 1;
}

message GetGroupConfigResponse {
  uint64      group_id = 1;
  GroupConfig config   = 2;
}

message UploadPDFRequest {
  string name = 1;
  bytes  file = 2;
}

message UploadPDFResponse {
  string hash = 1;
}

message ListUploadedPDFsRequest {
  uint32 page_number = 1;
  uint32 limit       = 2;
}

message ListUploadedPDFsResponse {
  uint32               total_count  = 1;
  uint32               page_size    = 2;
  uint32               total_page   = 3;
  uint32               current_page = 4;
  repeated UploadedPDF items        = 5;
}

message UploadedPDF {
  string hash        = 1;
  string name        = 2;
  uint64 size        = 3;
  string s3_path     = 4;
  uint64 uploaded_at = 5;
}

message UpdatePDFNameRequest {
  string hash = 1;
  string name = 2;
}

message UpdatePDFNameResponse {
}

message DeletePDFRequest {
  string hash = 1;
}

message DeletePDFResponse {
}

message PreviewPostPDFToGroupRequest {
  uint64 group_id = 1;
  string pdf_hash = 2;
}

message PreviewPostPDFToGroupResponse {
  string           preview_id   = 1;
  string           content_text = 2;
  repeated PDFFile pdf_files    = 3;
}

message PDFFile {
  string type        = 1;
  string origin_hash = 2;
  string hash        = 3;
  string name        = 4;
  uint64 size        = 5;
  string s3_path     = 6;
}

message ConfirmPostPDFToGroupRequest {
  string preview_id  = 1;
  uint64 schedule_at = 2;
}

message ConfirmPostPDFToGroupResponse {
}
